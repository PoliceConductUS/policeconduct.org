---
import SiteLayout from "../../layouts/SiteLayout.astro";
import { loadAgencySummaries } from "../../lib/data/summaries.js";
import UsaChoroplethMap from "../../components/UsaChoroplethMap.astro";
import { US_STATE_TILES } from "../../lib/geo/states.js";
import {
  buildItemList,
  buildWebPage,
  getSiteUrl,
} from "../../lib/structured-data.js";

const agencies = await loadAgencySummaries();
const stateStats = US_STATE_TILES.map((state) => {
  const count = agencies.filter(
    (agency) => agency.category?.toUpperCase() === state.code,
  ).length;
  return {
    code: state.code,
    count,
    href: `/law-enforcement-agency/${state.code.toLowerCase()}/`,
  };
});
const federalAgencies = agencies.filter(
  (agency) => agency.category === "federal",
);
const totalAgencies = agencies.length;
const pagePath = "/law-enforcement-agency/";
const suggestAgencyHref = `/law-enforcement-agency/new/?${new URLSearchParams({
  path: "/law-enforcement-agency/",
  message: "Suggest a new agency",
}).toString()}`;
const siteUrl = getSiteUrl(Astro.site);
const pageUrl = new URL(pagePath, siteUrl).toString();
const federalAgencyItems = federalAgencies.map((agency, index) => ({
  "@type": "ListItem",
  position: index + 1,
  item: {
    "@type": "GovernmentOrganization",
    name: agency.name,
    url: new URL(
      `/law-enforcement-agency/${agency.category}/${agency.slug}/`,
      siteUrl,
    ).toString(),
  },
}));
const structuredData = buildWebPage({
  siteUrl,
  pageUrl,
  name: "Law Enforcement Agencies",
  description:
    "Law enforcement agencies currently listed on PoliceConduct.org.",
  type: "CollectionPage",
});
const federalItemList = buildItemList(federalAgencyItems);
if (federalItemList) {
  structuredData.mainEntity = federalItemList;
}
---

<SiteLayout
  title="Law Enforcement Agencies"
  description="Law enforcement agencies currently listed on PoliceConduct.org."
  pagePath={pagePath}
  structuredData={structuredData}
>
  <main>
    <section class="py-vh-3 bg-gray-100 border-bottom border-dark">
      <div class="container">
        <div class="row g-4 align-items-end">
          <div class="col-12 col-lg-8">
            <p class="text-uppercase small text-muted mb-2">
              Law Enforcement Agencies
            </p>
            <h1 class="display-4 fw-bold">Law Enforcement Agencies</h1>
            <p class="lead text-muted mb-0">
              Law enforcement agencies tracked on PoliceConduct.org.
            </p>
            <div class="mt-3">
              <a
                class="btn btn-outline-dark rounded-0"
                href={suggestAgencyHref}
              >
                Suggest a new agency
              </a>
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="card shadow-sm rounded-0 border-dark">
              <div class="card-body d-flex flex-column gap-2">
                <div class="text-uppercase small text-muted">
                  Agencies listed
                </div>
                <div class="d-flex align-items-end justify-content-between">
                  <span class="display-6 fw-bold">{totalAgencies}</span>
                </div>
                <div class="text-muted small">
                  Hover over a state to see the count; click to view agencies.
                  Federal agencies are listed separately.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="py-vh-2">
      <div class="container">
        <div class="row g-4">
          <div class="col-12 col-lg-8">
            <UsaChoroplethMap
              stats={stateStats}
              title="States"
              subtitle="Click a state to jump to its agencies."
              emptyLabel="No agencies yet"
              interactionLabel="Hover over a state to see the count; click to view agencies."
            />
          </div>
          <div class="col-12 col-lg-4">
            <div class="card shadow-sm rounded-0 border-dark h-100">
              <div class="card-body d-flex flex-column gap-3">
                <div class="d-flex align-items-center justify-content-between">
                  <p class="text-uppercase small text-muted mb-0">
                    Federal agencies
                  </p>
                  <span class="badge bg-dark rounded-pill"
                    >{federalAgencies.length}</span
                  >
                </div>
                <ul class="list-unstyled d-flex flex-column gap-2 mb-0">
                  {
                    federalAgencies.map((agency) => (
                      <li class="d-flex align-items-start justify-content-between gap-2">
                        <a
                          class="text-decoration-none fw-semibold"
                          href={`/law-enforcement-agency/${agency.category}/${agency.slug}/`}
                        >
                          {agency.name}
                        </a>
                        <div class="d-flex align-items-center gap-2">
                          <span class="badge bg-light text-dark border rounded-pill">
                            Reports: {agency.reportCount}
                          </span>
                        </div>
                      </li>
                    ))
                  }
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
  <script
    is:inline
    id="dsq-count-scr"
    src="https://policeconduct.disqus.com/count.js"
    async></script>
</SiteLayout>
