---
import SiteLayout from "../../../../layouts/SiteLayout.astro";
import { US_STATE_TILES } from "../../../../lib/geo/states.js";
import type { ReportSummary } from "../../../../lib/data/types.js";
import { loadReportSummaries } from "../../../../lib/data/summaries.js";
import { getReportStateSlug } from "../../../../lib/report-state-stats.js";
import { buildItemList, getSiteUrl } from "../../../../lib/structured-data.js";

export async function getStaticPaths({ paginate }: { paginate: any }) {
  const pageSize = 50;
  const reports = await loadReportSummaries();
  const reportsByState = new Map<string, ReportSummary[]>();

  reports.forEach((report) => {
    const stateSlug = getReportStateSlug(report);
    if (!stateSlug) {
      return;
    }
    const list = reportsByState.get(stateSlug) || [];
    list.push(report);
    reportsByState.set(stateSlug, list);
  });

  const pages: any[] = [];
  reportsByState.forEach((stateReports, state) => {
    const statePages = paginate(stateReports, {
      pageSize,
      params: { state },
    });
    statePages
      .filter((page: any) => page.params.page !== "1")
      .forEach((page: any) => pages.push(page));
  });

  return pages;
}

const { page } = Astro.props;
const { state } = Astro.params;
const stateSlug = (state as string).toLowerCase();
const stateCode = stateSlug.toUpperCase();
const stateMeta = US_STATE_TILES.find((entry) => entry.code === stateCode);
const titleBase = stateMeta
  ? `${stateMeta.name} Reports`
  : `${stateCode} Reports`;
const title =
  page.currentPage > 1 ? `${titleBase} – Page ${page.currentPage}` : titleBase;
const pagePath = `/report/${stateSlug}/page/${page.currentPage}/`;
const prevUrl =
  page.currentPage === 2 ? `/report/${stateSlug}/` : page.url.prev?.toString();
const totalCount = page.total ?? page.data.length;
const siteUrl = getSiteUrl(Astro.site);
const pageUrl = new URL(pagePath, siteUrl).toString();
const reportItems = page.data.map((report: ReportSummary, index: number) => ({
  "@type": "ListItem",
  position: index + 1,
  item: {
    "@type": "Report",
    name: report.title,
    url: new URL(`/report/${stateSlug}/${report.slug}/`, siteUrl).toString(),
    ...(report.agencyName
      ? {
          about: {
            "@type": "GovernmentOrganization",
            name: report.agencyName,
          },
        }
      : {}),
  },
}));
const reportItemList = buildItemList(reportItems);
const websiteId = new URL("/", siteUrl).toString();
const breadcrumb = {
  "@type": "BreadcrumbList",
  "@id": `${pageUrl}#breadcrumb`,
  itemListElement: [
    {
      "@type": "ListItem",
      position: 1,
      name: "Home",
      item: websiteId,
    },
    {
      "@type": "ListItem",
      position: 2,
      name: "Reports",
      item: new URL("/report/", siteUrl).toString(),
    },
    {
      "@type": "ListItem",
      position: 3,
      name: stateMeta?.name || stateCode,
      item: new URL(`/report/${stateSlug}/`, siteUrl).toString(),
    },
    {
      "@type": "ListItem",
      position: 4,
      name: `Page ${page.currentPage}`,
      item: pageUrl,
    },
  ],
};
const reportItemListId = reportItemList ? `${pageUrl}#itemlist` : null;
const structuredData = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "WebSite",
      "@id": websiteId,
      url: websiteId,
      name: "PoliceConduct.org",
    },
    {
      "@type": "CollectionPage",
      "@id": pageUrl,
      url: pageUrl,
      name: title,
      description: `Reports recorded within ${stateMeta?.name || stateCode}.`,
      isPartOf: { "@id": websiteId },
      ...(reportItemListId ? { mainEntity: { "@id": reportItemListId } } : {}),
      breadcrumb: { "@id": breadcrumb["@id"] },
    },
    breadcrumb,
    ...(reportItemList ? [{ ...reportItemList, "@id": reportItemListId }] : []),
  ],
};

const formatDisplayDate = (value?: string | null) => {
  if (!value) return "—";
  const parsed = new Date(value);
  if (Number.isNaN(parsed.getTime())) return value;
  return parsed.toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
    year: "numeric",
  });
};
---

<SiteLayout
  title={title}
  pagePath={pagePath}
  canonicalUrl={pagePath}
  structuredData={structuredData}
>
  <main>
    <section class="py-vh-3 bg-gray-100 border-bottom border-dark">
      <div class="container">
        <div class="row g-4 align-items-end">
          <div class="col-12 col-lg-8">
            <nav aria-label="Breadcrumb">
              <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item">
                  <a class="link-dark" href="/">Home</a>
                </li>
                <li class="breadcrumb-item">
                  <a class="link-dark" href="/report/">Reports</a>
                </li>
                <li class="breadcrumb-item">
                  <a class="link-dark" href={`/report/${stateSlug}/`}>
                    {stateMeta?.name || stateCode}
                  </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                  Page {page.currentPage}
                </li>
              </ol>
            </nav>
            <p class="text-uppercase small text-muted mb-2">State reports</p>
            <h1 class="display-4 fw-bold">{title}</h1>
            <p class="lead text-muted mb-0">
              Showing published reports recorded within {
                stateMeta?.name || stateCode
              }.
            </p>
          </div>
          <div class="col-12 col-lg-4">
            <div class="card shadow-sm rounded-0 border-dark">
              <div class="card-body d-flex flex-column gap-2">
                <div class="text-uppercase small text-muted">Reports</div>
                <div class="d-flex align-items-end justify-content-between">
                  <span class="display-6 fw-bold">{totalCount}</span>
                  <span class="text-muted small">Published entries</span>
                </div>
                <div class="text-muted small">
                  Page {page.currentPage} of {page.lastPage}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="py-vh-2">
      <div class="container">
        {
          page.data.length === 0 ? (
            <div
              class="alert alert-secondary rounded-0 border-dark"
              role="status"
            >
              No reports listed yet for {stateMeta?.name || stateCode}.
            </div>
          ) : (
            <div class="row row-cols-1 g-3">
              {page.data.map((report: ReportSummary) => (
                <div class="col">
                  <article class="card shadow-sm border-0 rounded-0 h-100">
                    <div class="card-body d-flex flex-column gap-3">
                      <div class="row g-3 align-items-start">
                        <div class="col-auto">
                          <div class="text-uppercase small text-muted">
                            Date
                          </div>
                          <div class="fw-bold">
                            {formatDisplayDate(report.incidentDate)}
                          </div>
                        </div>
                        <div class="col-12 col-md">
                          <div class="text-uppercase small text-muted">
                            Title
                          </div>
                          <div class="d-flex align-items-center flex-wrap gap-2">
                            <a
                              class="link-dark fw-semibold"
                              href={`/report/${stateSlug}/${report.slug}/`}
                            >
                              {report.title}
                            </a>
                            {report.ratingOverall ? (
                              <span class="badge bg-warning text-dark rounded-0">
                                Rating {report.ratingOverall}
                              </span>
                            ) : null}
                          </div>
                        </div>
                        <div class="col-12 col-md">
                          <div class="text-uppercase small text-muted">
                            Location
                          </div>
                          <div>{report.address || "—"}</div>
                        </div>
                        <div class="col-12 col-md">
                          <div class="text-uppercase small text-muted">
                            Personnel
                          </div>
                          {report.personnel?.length ? (
                            <div class="d-flex flex-wrap align-items-center gap-1">
                              {report.personnel.map((person, index) => (
                                <>
                                  {index > 0 ? (
                                    <span class="mx-1 text-muted">•</span>
                                  ) : null}
                                  {person.slug ? (
                                    <a
                                      class="link-dark text-decoration-none"
                                      href={`/personnel/${person.slug}/`}
                                    >
                                      {person.name}
                                    </a>
                                  ) : (
                                    <span>{person.name}</span>
                                  )}
                                </>
                              ))}
                            </div>
                          ) : (
                            <span class="text-muted">—</span>
                          )}
                        </div>
                      </div>
                    </div>
                  </article>
                </div>
              ))}
            </div>
          )
        }
        <nav aria-label="Pagination" class="mt-4">
          {
            prevUrl ? (
              <a class="btn btn-outline-dark rounded-0 me-2" href={prevUrl}>
                Previous
              </a>
            ) : null
          }
          {
            page.url.next ? (
              <a
                class="btn btn-outline-dark rounded-0"
                href={page.url.next.toString()}
              >
                Next
              </a>
            ) : null
          }
        </nav>
      </div>
    </section>
  </main>
  <script
    is:inline
    id="dsq-count-scr"
    src="https://policeconduct.disqus.com/count.js"
    async></script>
</SiteLayout>
