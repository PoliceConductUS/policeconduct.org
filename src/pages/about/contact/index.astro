---
import SiteLayout from "../../../layouts/SiteLayout.astro";
---

<SiteLayout
  title="Contact | PoliceConduct.org"
  pagePath="/about/contact/"
  robots="noindex,follow"
>
  <main class="flex-grow-1 py-vh-3">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <nav aria-label="Breadcrumb">
            <ol class="breadcrumb mb-3">
              <li class="breadcrumb-item">
                <a class="link-dark" href="/about/">About</a>
              </li>
              <li class="breadcrumb-item active" aria-current="page">
                Contact
              </li>
            </ol>
          </nav>
          <h1 class="display-5 fw-bold">Contact us</h1>
          <p class="lead text-muted">
            Tell us who you are and how we can help.
          </p>
          <div class="alert alert-info rounded-0">
            You’ll probably see this form a lot—that’s intentional. It helps us
            learn which features people actually use before we invest in full
            automation. Your message guides what we build next.
          </div>
          <form
            name="contact"
            method="POST"
            data-netlify="true"
            data-netlify-honeypot="organization"
            class="needs-validation"
            novalidate
          >
            <input type="hidden" name="form-name" value="contact" />
            <div class="honeypot visually-hidden">
              <label>
                Organization
                <input type="text" name="organization" />
              </label>
            </div>
            <div class="form-floating mb-3">
              <select
                class="form-select"
                id="whoami"
                name="whoami"
                aria-label="I am a/an"
                required
              >
                <option selected disabled>Choose one</option>
                <option value="individual">
                  Individual with a complaint or commendation
                </option>
                <option value="police">Police department/Officer</option>
                <option value="oversight">Oversight committee</option>
                <option value="journalist">Journalist</option>
                <option value="donor">Donor/Supporter</option>
                <option value="partner">Partner / Potential Partner</option>
                <option value="volunteer">Volunteer</option>
                <option value="profile owner">Profile Owner</option>
                <option value="subscriber">Subscriber</option>
                <option value="other">Other</option>
              </select>
              <label for="whoami">I am a/an*</label>
              <div class="invalid-feedback">Please choose one option.</div>
            </div>
            <div class="form-floating mb-3">
              <input
                type="text"
                class="form-control"
                id="firstName"
                name="firstName"
                placeholder="First Name"
                required
              />
              <label for="firstName">First Name*</label>
              <div class="invalid-feedback">Please enter your first name.</div>
            </div>
            <div class="form-floating mb-3">
              <input
                type="text"
                class="form-control"
                id="lastName"
                name="lastName"
                placeholder="Last Name"
                required
              />
              <label for="lastName">Last Name*</label>
              <div class="invalid-feedback">Please enter your last name.</div>
            </div>
            <div class="form-floating mb-3">
              <input
                type="email"
                class="form-control"
                id="email"
                name="email"
                placeholder="name@example.com"
                required
              />
              <label for="email">Email address*</label>
              <div class="invalid-feedback">Please enter a valid email.</div>
            </div>
            <div class="form-floating mb-3">
              <input
                type="tel"
                class="form-control"
                id="phone"
                name="phone"
                placeholder="Phone Number"
              />
              <label for="phone">Phone Number (optional)</label>
            </div>
            <div class="form-floating mb-3">
              <textarea
                class="form-control"
                placeholder="Leave a message here"
                id="message"
                name="message"
                style="height: 150px"
                required></textarea>
              <label for="message">Message*</label>
              <div class="invalid-feedback">Please include a message.</div>
            </div>
            <div class="form-check mb-3">
              <input
                class="form-check-input"
                type="checkbox"
                value="Yes"
                id="rememberContact"
              />
              <label class="form-check-label" for="rememberContact">
                Remember my details on this device (clears when the browser
                closes).
              </label>
            </div>
            <div class="small text-muted mb-3">
              Protected by reCAPTCHA Enterprise.
            </div>
            <button type="submit" class="btn btn-dark btn-lg rounded-0">
              Submit
            </button>
          </form>
        </div>
      </div>
    </div>
  </main>
  <script is:inline>
    (function () {
      const select = document.getElementById("whoami");
      const messageInput = document.getElementById("message");
      const firstNameInput = document.getElementById("firstName");
      const lastNameInput = document.getElementById("lastName");
      const emailInput = document.getElementById("email");
      const phoneInput = document.getElementById("phone");
      const rememberInput = document.getElementById("rememberContact");
      const storageKey = "ipc_contact_session_v1";
      if (!select) {
        return;
      }
      const params = new URLSearchParams(window.location.search);
      const value = (
        params.get("whoami") ||
        params.get("role") ||
        ""
      ).toLowerCase();
      if (!value) {
        if (messageInput) {
          const message = params.get("message");
          if (message && !messageInput.value.trim()) {
            messageInput.value = message;
          }
        }
        return;
      }
      const options = Array.from(select.options);
      const match = options.find(
        (opt) =>
          opt.value.toLowerCase() === value ||
          opt.textContent.toLowerCase().includes(value),
      );
      if (match) {
        match.selected = true;
      }
      if (messageInput) {
        const message = params.get("message");
        if (message && !messageInput.value.trim()) {
          messageInput.value = message;
        }
      }
      if (
        firstNameInput &&
        lastNameInput &&
        emailInput &&
        phoneInput &&
        rememberInput
      ) {
        try {
          const saved = sessionStorage.getItem(storageKey);
          if (saved) {
            const data = JSON.parse(saved);
            if (data.firstName && !firstNameInput.value.trim()) {
              firstNameInput.value = data.firstName;
            }
            if (data.lastName && !lastNameInput.value.trim()) {
              lastNameInput.value = data.lastName;
            }
            if (data.email && !emailInput.value.trim()) {
              emailInput.value = data.email;
            }
            if (data.phone && !phoneInput.value.trim()) {
              phoneInput.value = data.phone;
            }
            rememberInput.checked = true;
          }
        } catch (err) {
          // Ignore storage errors.
        }
      }
    })();
  </script>

  <script is:inline>
    (function () {
      const form = document.querySelector('form[name="contact"]');
      const rememberInput = document.getElementById("rememberContact");
      const storageKey = "ipc_contact_session_v1";
      if (!form) {
        return;
      }
      form.addEventListener("submit", async function (event) {
        const submitButton = form.querySelector('button[type="submit"]');
        let inlineError = form.querySelector("[data-form-submit-error]");
        if (!inlineError) {
          inlineError = document.createElement("div");
          inlineError.setAttribute("data-form-submit-error", "true");
          inlineError.className = "alert alert-danger rounded-0 mt-3 d-none";
          inlineError.setAttribute("role", "alert");
          form.appendChild(inlineError);
        }
        const formsUi = window.__IPC_FORMS__;
        if (!formsUi || typeof formsUi.ensureSubmissionUi !== "function") {
          inlineError.textContent =
            "Unable to submit the form right now. Please refresh and try again. If you cannot submit this form, print this page and email it to hello@policeconduct.org.";
          inlineError.classList.remove("d-none");
          return;
        }
        formsUi.prewarmRecaptcha?.();
        const { inlineSuccess } = formsUi.ensureSubmissionUi({
          form,
          submitButton,
          onReset: function () {
            form.classList.remove("was-validated");
          },
        });

        let submissionCompleted = false;

        if (form.dataset.submitLocked === "true") {
          event.preventDefault();
          return;
        }

        event.preventDefault();
        form.dataset.submitLocked = "true";
        formsUi.setSubmitBusy(submitButton, true);
        inlineError.classList.add("d-none");
        inlineError.textContent = "";

        inlineSuccess.classList.add("d-none");

        try {
          if (!form.checkValidity()) {
            event.stopPropagation();
            form.classList.add("was-validated");
            return;
          }
          form.classList.add("was-validated");

          if (rememberInput && rememberInput.checked) {
            try {
              const payload = {
                firstName: document.getElementById("firstName")?.value.trim(),
                lastName: document.getElementById("lastName")?.value.trim(),
                email: document.getElementById("email")?.value.trim(),
                phone: document.getElementById("phone")?.value.trim(),
              };
              sessionStorage.setItem(storageKey, JSON.stringify(payload));
            } catch (err) {
              // Ignore storage errors.
            }
          } else if (rememberInput) {
            try {
              sessionStorage.removeItem(storageKey);
            } catch (err) {
              // Ignore storage errors.
            }
          }

          const formData = new FormData(form);
          const recaptchaToken =
            await formsUi.getRecaptchaToken("contact_submit");

          const data = {};
          formData.forEach((value, key) => {
            if (key === "form-name" || key === "g-recaptcha-response") {
              return;
            }
            if (key in data) {
              if (!Array.isArray(data[key])) {
                data[key] = [data[key]];
              }
              data[key].push(value);
            } else {
              data[key] = value;
            }
          });

          const response = await fetch("/api/forms/submit", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              formName: "contact",
              recaptchaToken,
              data,
            }),
          });

          if (!response.ok) {
            let message =
              "We could not submit your form right now. Please print this page and email it to hello@policeconduct.org so we have your submission while we fix the issue.";
            try {
              const errorPayload = await response.json();
              if (
                errorPayload &&
                typeof errorPayload.error === "string" &&
                errorPayload.error.trim()
              ) {
                message = errorPayload.error.trim();
              }
            } catch (_error) {
              // Ignore malformed error payloads.
            }
            throw new Error(message);
          }

          const result = await response.json();
          const submissionId =
            typeof result?.submissionId === "string" ? result.submissionId : "";
          if (!submissionId) {
            throw new Error(
              "Submission succeeded but no submission ID was returned.",
            );
          }
          form.classList.remove("was-validated");
          const submissionIdNode = inlineSuccess.querySelector(
            "[data-submission-id]",
          );
          if (submissionIdNode) {
            submissionIdNode.textContent = submissionId;
          }
          formsUi.setSubmitBusy(submitButton, false);
          if (submitButton) submitButton.disabled = true;
          inlineSuccess.classList.remove("d-none");
          inlineSuccess.scrollIntoView({ behavior: "smooth", block: "center" });
          submissionCompleted = true;
        } catch (error) {
          const message =
            error instanceof Error && error.message
              ? error.message
              : "Unable to submit the form. Please try again.";
          const fallback =
            formsUi.blockedSubmitFallback ||
            "If you cannot submit this form, print this page and email it to hello@policeconduct.org.";
          inlineError.textContent = message.includes("hello@policeconduct.org")
            ? message
            : message + " " + fallback;
          inlineError.classList.remove("d-none");
        } finally {
          if (!submissionCompleted) formsUi.setSubmitBusy(submitButton, false);
          if (!submissionCompleted) form.dataset.submitLocked = "false";
        }
      });
    })();
  </script>
</SiteLayout>
