---
import type { AgencySummary } from "../lib/data/types.js";

const { agency } = Astro.props as { agency: AgencySummary };

const formatDate = (value: string | null) => {
  if (!value) {
    return null;
  }
  const date = new Date(value);
  if (Number.isNaN(date.getTime())) {
    return null;
  }
  return date.toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
    year: "numeric",
  });
};

const detailUrl = `/law-enforcement-agency/${agency.category}/${agency.slug}/`;
const lastUpdatedLabel = formatDate(agency.lastUpdatedAt);
const categoryLabel = agency.category === "federal" ? "Federal" : null;
const showCategory = Boolean(categoryLabel);
const personnelLabel = `${agency.activePersonnelCount} personnel`;
const reportLabel = `${agency.reportCount} reports`;
const locationLabel = [agency.city, agency.state, agency.zipCode]
  .filter(Boolean)
  .join(", ");
const phoneHref = agency.phoneNumber
  ? agency.phoneNumber.replace(/[^\d+]/g, "")
  : null;
---

<article class="card h-100 shadow-sm border-0 rounded-0">
  <div class="card-body d-flex flex-column gap-3">
    <div class="flex-grow-1 position-relative">
      <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
        {
          showCategory ? (
            <span class="badge bg-light text-dark border rounded-0 text-uppercase">
              {categoryLabel}
            </span>
          ) : null
        }
      </div>
      <h3 class="h5 mb-1">
        <a
          class="link-dark text-decoration-none stretched-link"
          href={detailUrl}
        >
          {agency.name}
        </a>
      </h3>
      {agency.address ? <div class="text-muted">{agency.address}</div> : null}
      {locationLabel ? <div class="text-muted">{locationLabel}</div> : null}
      {
        agency.phoneNumber ? (
          <div class="text-muted small">
            {phoneHref ? (
              <a
                class="link-dark text-decoration-none"
                href={`tel:${phoneHref}`}
              >
                {agency.phoneNumber}
              </a>
            ) : (
              agency.phoneNumber
            )}
          </div>
        ) : null
      }
    </div>
    <div
      class="d-flex flex-wrap gap-2 align-items-center text-muted small border-top pt-2"
    >
      <span class="badge bg-light text-dark border rounded-0"
        >{personnelLabel}</span
      >
      <span class="badge bg-light text-dark border rounded-0"
        >{reportLabel}</span
      >
      {
        lastUpdatedLabel ? (
          <span class="ms-auto fw-semibold text-dark">
            Updated {lastUpdatedLabel}
          </span>
        ) : null
      }
    </div>
  </div>
</article>
